<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<!-- iPhone Optimization: Viewport fit cover and scalable settings -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<!-- iOS Web App Capability -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Spark Pro">

<title>SPARK TRADING BOT PRO V2.0</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* --- CORE VARIABLES & RESET --- */
:root {
  --primary: #00ffcc;
  --secondary: #0088ff;
  --accent: #ff00cc;
  --success: #00ff9d;
  --danger: #ff3860;
  --dark-bg: #05070a;
  --card-bg: rgba(13, 20, 35, 0.75);
  --glass-border: rgba(0, 255, 204, 0.15);
  --text-main: #e0e0ff;
  --text-muted: #8aa;
  --font-display: 'Orbitron', sans-serif;
  --font-body: 'Rajdhani', sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

body {
  font-family: var(--font-body);
  background-color: var(--dark-bg);
  color: var(--text-main);
  min-height: 100vh;
  overflow-x: hidden;
  font-size: 16px;
  line-height: 1.5;
  /* iOS Safe Area handling */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
}

/* --- LIVE WALLPAPER BACKGROUND --- */
#canvas-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background: radial-gradient(circle at 50% 50%, #1a253a 0%, #05070a 100%);
}

/* --- LAYOUT & CONTAINER --- */
.app-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  display: grid;
  grid-template-columns: 300px 1fr 300px;
  gap: 20px;
  position: relative;
  z-index: 10;
  min-height: 100vh;
}

/* --- GLASSMORPHISM CARD STYLE --- */
.glass-panel {
  background: var(--card-bg);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s;
  position: relative;
  overflow: hidden;
}

.glass-panel:hover {
  border-color: rgba(0, 255, 204, 0.4);
  box-shadow: 0 10px 40px rgba(0, 255, 204, 0.1);
}

.glass-panel::before {
  content: '';
  position: absolute;
  top: 0; left: 0; width: 100%; height: 2px;
  background: linear-gradient(90deg, transparent, var(--primary), transparent);
  opacity: 0.5;
}

/* --- HEADER --- */
.header {
  grid-column: 1 / -1;
  text-align: center;
  padding: 30px;
  margin-bottom: 10px;
  position: relative;
  background: rgba(5, 7, 10, 0.8);
}

.logo-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  margin-bottom: 10px;
}

.logo-img {
  width: 60px;
  height: 60px;
  filter: drop-shadow(0 0 10px var(--primary));
  animation: pulseLogo 3s infinite ease-in-out;
}

@keyframes pulseLogo {
  0%, 100% { filter: drop-shadow(0 0 10px var(--primary)); transform: scale(1); }
  50% { filter: drop-shadow(0 0 20px var(--secondary)); transform: scale(1.05); }
}

h1 {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 2.5rem;
  background: linear-gradient(180deg, #fff, var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-transform: uppercase;
  letter-spacing: 2px;
  text-shadow: 0 0 30px rgba(0, 255, 204, 0.4);
}

.subtitle {
  color: var(--secondary);
  font-size: 1.1rem;
  letter-spacing: 4px;
  text-transform: uppercase;
  font-weight: 600;
  margin-bottom: 10px;
}

#clock {
  font-family: monospace;
  color: var(--text-muted);
  font-size: 0.9rem;
  background: rgba(0,0,0,0.3);
  padding: 5px 15px;
  border-radius: 20px;
  display: inline-block;
  border: 1px solid rgba(255,255,255,0.1);
}

/* --- TYPOGRAPHY UTILS --- */
.panel-title {
  font-family: var(--font-display);
  color: var(--primary);
  font-size: 1.1rem;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding-bottom: 10px;
}

.stat-value {
  font-family: var(--font-display);
  font-size: 1.8rem;
  font-weight: 700;
  color: #fff;
}

.stat-label {
  font-size: 0.8rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* --- BUTTONS --- */
.btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 8px;
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 10px;
  outline: none;
}

.btn-primary {
  background: linear-gradient(135deg, rgba(0, 255, 204, 0.1), rgba(0, 136, 255, 0.1));
  border: 1px solid var(--primary);
  color: var(--primary);
  box-shadow: 0 0 15px rgba(0, 255, 204, 0.1);
}

.btn-primary:hover {
  background: var(--primary);
  color: #000;
  box-shadow: 0 0 30px rgba(0, 255, 204, 0.6);
}

.btn-secondary {
  background: linear-gradient(135deg, rgba(255, 0, 204, 0.1), rgba(136, 0, 255, 0.1));
  border: 1px solid var(--accent);
  color: var(--accent);
}

.btn-secondary:hover {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 0 30px rgba(255, 0, 204, 0.6);
}

.btn-action {
  background: linear-gradient(90deg, #ff9a00, #ff5e00);
  color: white;
  font-size: 1.1rem;
  box-shadow: 0 0 20px rgba(255, 154, 0, 0.4);
  animation: pulseBtn 2s infinite;
}

@keyframes pulseBtn {
  0% { box-shadow: 0 0 0 0 rgba(255, 154, 0, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(255, 154, 0, 0); }
  100% { box-shadow: 0 0 0 0 rgba(255, 154, 0, 0); }
}

.btn:active { transform: scale(0.98); }

/* --- INPUTS --- */
select {
  width: 100%;
  background: rgba(0,0,0,0.4);
  border: 1px solid rgba(255,255,255,0.2);
  color: #fff;
  padding: 12px;
  border-radius: 8px;
  font-family: var(--font-body);
  font-size: 1rem;
  margin-bottom: 15px;
  outline: none;
  cursor: pointer;
}

select:focus { border-color: var(--primary); }

/* --- MODULES: ENERGY --- */
.energy-bar-wrap {
  width: 100%;
  height: 14px;
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  margin: 15px 0;
  overflow: hidden;
  position: relative;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
}

.energy-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.energy-fill::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  transform: translateX(-100%);
  animation: shine 2s infinite;
}

@keyframes shine { to { transform: translateX(100%); } }

/* --- MODULES: CHART --- */
.chart-wrapper {
  height: 350px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 12px;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.05);
  margin-bottom: 15px;
}

canvas#mainChart {
  width: 100%;
  height: 100%;
}

.chart-overlay-info {
  position: absolute;
  top: 10px;
  left: 10px;
  display: flex;
  gap: 15px;
  font-size: 0.8rem;
  font-family: monospace;
  pointer-events: none;
}

.info-item span { color: var(--primary); font-weight: bold; }

/* --- MODULES: SIGNAL OUTPUT --- */
.signal-box {
  background: rgba(0,0,0,0.5);
  border-radius: 12px;
  padding: 20px;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  border: 1px dashed rgba(255,255,255,0.1);
  margin-bottom: 20px;
  transition: all 0.3s;
}

.signal-box.active {
  border-style: solid;
  border-color: var(--primary);
  box-shadow: 0 0 30px rgba(0,255,204,0.1);
}

.signal-direction {
  font-size: 2.5rem;
  font-weight: 800;
  font-family: var(--font-display);
  margin: 10px 0;
  text-shadow: 0 0 20px currentColor;
}

.buy-sig { color: var(--success); }
.sell-sig { color: var(--danger); }

.signal-details {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
  width: 100%;
  margin-top: 15px;
  border-top: 1px solid rgba(255,255,255,0.1);
  padding-top: 15px;
}

.detail-item { font-size: 0.9rem; }
.detail-val { font-weight: bold; color: #fff; font-size: 1.1rem; display: block; }

.ai-reasoning {
  margin-top: 15px;
  font-size: 0.85rem;
  color: var(--primary);
  background: rgba(0, 255, 204, 0.1);
  padding: 10px;
  border-radius: 8px;
  border-left: 3px solid var(--primary);
  width: 100%;
  text-align: left;
  animation: fadeIn 0.5s ease-out;
}

/* Scanning Animation */
.scanner {
  width: 100%;
  text-align: center;
}
.scan-line {
  height: 4px;
  background: var(--primary);
  width: 0%;
  margin: 10px auto;
  border-radius: 2px;
  box-shadow: 0 0 10px var(--primary);
  animation: scanAnim 2s ease-in-out infinite;
}
@keyframes scanAnim {
  0% { width: 0%; opacity: 0.5; }
  50% { width: 80%; opacity: 1; }
  100% { width: 100%; opacity: 0; }
}

/* --- MODULES: TRADERS & PAIRS --- */
.trader-list {
  max-height: 400px;
  overflow-y: auto;
  padding-right: 5px;
}

.trader-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  background: rgba(255,255,255,0.03);
  margin-bottom: 8px;
  border-radius: 6px;
  font-size: 0.9rem;
  animation: slideIn 0.4s ease-out forwards;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}

/* --- SCROLLBAR --- */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }

/* --- LANGUAGE SELECTOR --- */
.lang-fab {
  position: fixed;
  top: 20px; left: 20px;
  z-index: 100;
  width: 50px; height: 50px;
  border-radius: 50%;
  background: rgba(10, 20, 30, 0.9);
  border: 1px solid var(--primary);
  color: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
  transition: all 0.3s;
}
.lang-fab:hover { transform: rotate(15deg); }

.lang-menu {
  position: fixed;
  top: 80px; left: 20px;
  background: rgba(5, 10, 20, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 10px;
  display: none;
  z-index: 99;
  max-height: 400px;
  overflow-y: auto;
  width: 200px;
}

.lang-opt {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border-radius: 5px;
  cursor: pointer;
  color: #fff;
}
.lang-opt:hover { background: rgba(0, 255, 204, 0.2); }
.lang-flag { width: 24px; border-radius: 2px; }

/* --- AI CHAT --- */
.ai-fab {
  position: fixed;
  bottom: 30px; right: 30px;
  width: 60px; height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--secondary), var(--primary));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: #000;
  cursor: pointer;
  z-index: 100;
  box-shadow: 0 0 30px rgba(0, 255, 204, 0.4);
  animation: bounce 2s infinite;
}
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.chat-window {
  position: fixed;
  bottom: 100px; right: 30px;
  width: 320px;
  height: 450px;
  background: #0a1018;
  border: 1px solid var(--primary);
  border-radius: 15px;
  display: none;
  z-index: 99;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 0 50px rgba(0,0,0,0.8);
}

.chat-header {
  padding: 15px;
  background: linear-gradient(90deg, rgba(0,255,204,0.1), transparent);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  color: var(--primary);
  font-family: var(--font-display);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-body {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  font-size: 0.9rem;
}

.chat-input-area {
  padding: 15px;
  border-top: 1px solid rgba(255,255,255,0.1);
  display: flex;
}

.chat-input-area input {
  flex: 1;
  background: rgba(255,255,255,0.05);
  border: none;
  padding: 10px;
  color: #fff;
  border-radius: 5px;
}

.msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 10px; max-width: 80%; word-wrap: break-word; }
.msg-user { background: rgba(0, 136, 255, 0.3); align-self: flex-end; margin-left: auto; text-align: right; border-bottom-right-radius: 2px; }
.msg-bot { background: rgba(0, 255, 204, 0.1); align-self: flex-start; border: 1px solid rgba(0,255,204,0.2); border-bottom-left-radius: 2px; }
.msg-loading { opacity: 0.6; font-style: italic; }

/* --- RESPONSIVE --- */
@media (max-width: 1100px) {
  .app-container {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto auto;
  }
  .header { margin-bottom: 0; }
  .chart-wrapper { height: 300px; }
}
</style>
</head>
<body>

<canvas id="canvas-bg"></canvas>

<!-- Language Selector -->
<div class="lang-fab" id="langBtn" onclick="toggleLangMenu()">
  <i class="fas fa-globe"></i>
</div>
<div class="lang-menu" id="langMenu">
  <!-- Filled via JS -->
</div>

<!-- AI Chat -->
<div class="ai-fab" id="aiBtn" onclick="toggleChat()">
  <i class="fas fa-robot"></i>
</div>
<div class="chat-window" id="chatWindow">
  <div class="chat-header">
    <span>âœ¨ SPARK AI ASSISTANT</span>
    <span style="font-size:0.7rem; opacity:0.7;">POWERED BY GEMINI</span>
  </div>
  <div class="chat-body" id="chatBody">
    <div class="msg msg-bot">Hello! I am Spark AI. I can analyze markets, explain indicators, or chat about trading psychology. What's on your mind?</div>
  </div>
  <div class="chat-input-area">
    <input type="text" id="chatInput" placeholder="Ask Spark AI..." onkeypress="handleChat(event)">
  </div>
</div>

<div class="app-container">
  
  <!-- Header -->
  <div class="header glass-panel">
    <div class="logo-container">
      <img src="https://cdn-icons-png.flaticon.com/512/4712/4712054.png" class="logo-img" alt="Logo">
      <div>
        <h1 id="mainTitle">SPARK TRADING PRO</h1>
        <div class="subtitle" id="subtitle">QUANTUM ALGORITHMIC SYSTEM FOR IPHONE</div>
      </div>
    </div>
    <div id="clock">00:00:00</div>
  </div>

  <!-- Left Sidebar: Controls & Stats -->
  <div class="left-panel">
    
    <!-- Energy Card -->
    <div class="glass-panel" style="margin-bottom: 20px;">
      <div class="panel-title"><i class="fas fa-bolt"></i> <span id="energyTitle">ENERGY CORE</span></div>
      
      <div style="display:flex; justify-content:space-between; align-items:flex-end;">
        <span class="stat-label">Available Power</span>
        <span class="stat-value" id="energyValue" style="color:var(--primary)">0</span>
      </div>
      
      <div class="energy-bar-wrap">
        <div class="energy-fill" id="energyBar"></div>
      </div>
      
      <button class="btn btn-primary" onclick="promptEnergy()">
        <i class="fas fa-plus-circle"></i> <span id="addEnergyBtn">Inject Code</span>
      </button>
      
      <!-- REMOVED FREE ENERGY BUTTON -->
      
    </div>

    <!-- Stats Card -->
    <div class="glass-panel">
      <div class="panel-title"><i class="fas fa-chart-pie"></i> <span id="statsTitle">PERFORMANCE</span></div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
        <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; text-align:center;">
          <div class="stat-value" id="profitTotal">$0</div>
          <div class="stat-label" id="profitLabel">Profit</div>
        </div>
        <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; text-align:center;">
          <div class="stat-value" id="winStreak" style="color:var(--secondary)">0</div>
          <div class="stat-label" id="streakLabel">Streak</div>
        </div>
      </div>
      
      <div style="display:flex; justify-content:space-between; font-size:0.9rem; color:var(--text-muted); padding:5px 0;">
        <span id="signalsLabel">Signals:</span> <strong style="color:#fff" id="signalsGenerated">0</strong>
      </div>
      <div style="display:flex; justify-content:space-between; font-size:0.9rem; color:var(--text-muted); padding:5px 0;">
        <span id="successLabel">Win Rate:</span> <strong style="color:var(--success)" id="successRate">0%</strong>
      </div>
    </div>

  </div>

  <!-- Center Panel: Chart & Analysis -->
  <div class="center-panel">
    
    <!-- Market Selector -->
    <div class="glass-panel" style="margin-bottom: 20px;">
      <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
        <select id="marketType" onchange="updateAssets()">
          <option value="real">Real Market</option>
          <option value="otc">OTC Market</option>
        </select>
        <select id="assetSelect" onchange="resetChart()"></select>
      </div>
    </div>

    <!-- Live Chart -->
    <div class="chart-wrapper">
      <canvas id="mainChart"></canvas>
      <div class="chart-overlay-info">
        <div class="info-item">O: <span id="candleOpen">0.00</span></div>
        <div class="info-item">H: <span id="candleHigh">0.00</span></div>
        <div class="info-item">L: <span id="candleLow">0.00</span></div>
        <div class="info-item">C: <span id="candleClose">0.00</span></div>
      </div>
    </div>

    <!-- Signal Output Area -->
    <div class="glass-panel signal-box" id="signalBox">
      <div id="signalPlaceholder">
        <i class="fas fa-radar" style="font-size:3rem; color:rgba(255,255,255,0.1); margin-bottom:10px;"></i>
        <div id="readyMsg">SYSTEM READY. WAITING FOR ANALYSIS...</div>
      </div>
      
      <div id="scanningUI" style="display:none; width:100%;">
        <div class="stat-label" id="scanStatus">INITIALIZING NEURAL NET...</div>
        <div class="scan-line"></div>
        <div style="font-family:monospace; color:var(--primary); margin-top:10px;">
          RSI: <span id="scanRsi">--</span> | MACD: <span id="scanMacd">--</span>
        </div>
      </div>

      <div id="resultUI" style="display:none; width:100%;">
        <div class="stat-label">RECOMMENDED ACTION</div>
        <div class="signal-direction" id="signalText">CALL</div>
        <div class="signal-details">
          <div class="detail-item"><span class="detail-val" id="resRsi">50</span>RSI (14)</div>
          <div class="detail-item"><span class="detail-val" id="resTrend">UP</span>TREND</div>
          <div class="detail-item"><span class="detail-val" id="resReliability">92%</span>CONFIDENCE</div>
        </div>
        <div id="aiReasoning" class="ai-reasoning">
          âœ¨ <i class="fas fa-spinner fa-spin"></i> Spark AI is analyzing chart patterns...
        </div>
        <div style="margin-top:15px; font-size:0.8rem; color:var(--text-muted);">
          EXPIRY: <span style="color:#fff">1 MINUTE</span>
        </div>
      </div>
    </div>

    <!-- Action Button -->
    <button class="btn btn-action" onclick="startAnalysis()">
      <i class="fas fa-fingerprint"></i> <span id="generateSignalBtn">SCAN MARKET (1 MIN)</span>
    </button>

  </div>

  <!-- Right Panel: Social & Feed -->
  <div class="right-panel">
    
    <div class="glass-panel" style="margin-bottom:20px; text-align:center;">
      <div class="panel-title" style="justify-content:center;">COMMUNITY</div>
      <div style="display:flex; justify-content:center; gap:20px; margin-top:10px;">
        <a href="https://t.me/SparkTradingBot_Pro" target="_blank" style="color:#0088cc; font-size:2rem;"><i class="fab fa-telegram"></i></a>
        <a href="https://youtube.com/@cybersparktrading" target="_blank" style="color:#ff0000; font-size:2rem;"><i class="fab fa-youtube"></i></a>
      </div>
    </div>

    <div class="glass-panel" style="height:400px; display:flex; flex-direction:column;">
      <div class="panel-title"><i class="fas fa-globe-americas"></i> <span id="tradersTitle">LIVE RESULTS</span></div>
      <div class="trader-list" id="traderFeed">
        <!-- Feed Items -->
      </div>
    </div>

    <div class="glass-panel" style="margin-top:20px;">
      <div class="panel-title"><i class="fas fa-fire"></i> <span id="pairsTitle">HOT ASSETS</span></div>
      <div id="hotPairsList">
        <!-- Hot pairs inserted via JS -->
      </div>
    </div>

  </div>

</div>

<!-- Audio -->
<audio id="sfxClick" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
<audio id="sfxWin" src="https://www.myinstants.com/media/sounds/success-fanfare.mp3"></audio>

<script>
/**
 * SPARK TRADING BOT PRO V2.0 + GEMINI AI
 * Core Logic & UI Controller
 */

/* --- GEMINI API CONFIGURATION --- */
const apiKey = ""; // API Key provided by runtime environment
const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

async function callGemini(promptText) {
  try {
    const response = await fetch(GEMINI_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: promptText }] }]
      })
    });
    
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Analysis unavailable at the moment.";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "AI system is calibrating. Please try again.";
  }
}

/* --- DATA & TRANSLATIONS --- */
const translations = {
  en: {
    mainTitle: "SPARK TRADING PRO",
    subtitle: "QUANTUM ALGORITHMIC SYSTEM",
    energyTitle: "ENERGY CORE",
    addEnergyBtn: "INJECT CODE",
    claimEnergyBtn: "FREE ENERGY",
    statsTitle: "PERFORMANCE",
    signalsLabel: "Signals:",
    successLabel: "Win Rate:",
    profitLabel: "Profit",
    streakLabel: "Streak",
    generateSignalBtn: "SCAN MARKET (1 MIN)",
    tradersTitle: "LIVE RESULTS",
    pairsTitle: "HOT ASSETS",
    readyMsg: "SYSTEM READY. WAITING FOR ANALYSIS...",
    scanStatus: "SCANNING MARKET DATA...",
    resReliability: "CONFIDENCE",
    trend: "TREND",
    aiWelcome: "Hello! I am Spark AI. Ready to analyze the markets?"
  },
  id: {
    mainTitle: "SPARK TRADING PRO",
    subtitle: "SISTEM ALGORITMA KUANTUM",
    energyTitle: "INTI ENERGI",
    addEnergyBtn: "MASUKKAN KODE",
    claimEnergyBtn: "ENERGI GRATIS",
    statsTitle: "PERFORMA",
    signalsLabel: "Sinyal:",
    successLabel: "Rasio Menang:",
    profitLabel: "Profit",
    streakLabel: "Beruntun",
    generateSignalBtn: "PINDAI PASAR (1 MENIT)",
    tradersTitle: "HASIL LANGSUNG",
    pairsTitle: "ASET PANAS",
    readyMsg: "SISTEM SIAP. MENUNGGU ANALISIS...",
    scanStatus: "MEMINDAI DATA PASAR...",
    resReliability: "KEPERCAYAAN",
    trend: "TREN",
    aiWelcome: "Halo! Saya Spark AI. Siap menganalisis pasar?"
  },
  es: {
    mainTitle: "SPARK TRADING PRO",
    subtitle: "SISTEMA ALGORÃTMICO CUÃNTICO",
    energyTitle: "NÃšCLEO DE ENERGÃA",
    addEnergyBtn: "INSERTAR CÃ“DIGO",
    claimEnergyBtn: "ENERGÃA GRATIS",
    statsTitle: "RENDIMIENTO",
    signalsLabel: "SeÃ±ales:",
    successLabel: "Tasa de Ganancia:",
    profitLabel: "Beneficio",
    streakLabel: "Racha",
    generateSignalBtn: "ESCANEAR MERCADO (1 MIN)",
    tradersTitle: "RESULTADOS EN VIVO",
    pairsTitle: "ACTIVOS CALIENTES",
    readyMsg: "SISTEMA LISTO. ESPERANDO ANÃLISIS...",
    scanStatus: "ESCANEANDO DATOS DE MERCADO...",
    resReliability: "CONFIANZA",
    trend: "TENDENCIA",
    aiWelcome: "Â¡Hola! Soy Spark AI. Â¿Listo para analizar los mercados?"
  },
  pt: {
    mainTitle: "SPARK TRADING PRO",
    subtitle: "SISTEMA ALGORÃTMICO QUÃ‚NTICO",
    energyTitle: "NÃšCLEO DE ENERGIA",
    addEnergyBtn: "INSERIR CÃ“DIGO",
    claimEnergyBtn: "ENERGIA GRÃTIS",
    statsTitle: "DESEMPENHO",
    signalsLabel: "Sinais:",
    successLabel: "Taxa de VitÃ³ria:",
    profitLabel: "Lucro",
    streakLabel: "SequÃªncia",
    generateSignalBtn: "ESCANEAR MERCADO (1 MIN)",
    tradersTitle: "RESULTADOS AO VIVO",
    pairsTitle: "ATIVOS QUENTES",
    readyMsg: "SISTEMA PRONTO. AGUARDANDO ANÃLISE...",
    scanStatus: "ESCANEANDO DADOS DE MERCADO...",
    resReliability: "CONFIANÃ‡A",
    trend: "TENDÃŠNCIA",
    aiWelcome: "OlÃ¡! Sou Spark AI. Pronto para analisar os mercados?"
  },
  ru: {
    mainTitle: "SPARK TRADING PRO",
    subtitle: "ÐšÐ’ÐÐÐ¢ÐžÐ’ÐÐ¯ ÐÐ›Ð“ÐžÐ Ð˜Ð¢ÐœÐ˜Ð§Ð•Ð¡ÐšÐÐ¯ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ",
    energyTitle: "Ð¯Ð”Ð Ðž Ð­ÐÐ•Ð Ð“Ð˜Ð˜",
    addEnergyBtn: "Ð’Ð’Ð•Ð¡Ð¢Ð˜ ÐšÐžÐ”",
    claimEnergyBtn: "Ð‘Ð•Ð¡ÐŸÐ›ÐÐ¢ÐÐÐ¯ Ð­ÐÐ•Ð Ð“Ð˜Ð¯",
    statsTitle: "Ð­Ð¤Ð¤Ð•ÐšÐ¢Ð˜Ð’ÐÐžÐ¡Ð¢Ð¬",
    signalsLabel: "Ð¡Ð¸Ð³Ð½Ð°Ð»Ñ‹:",
    successLabel: "Ð’Ð¸Ð½Ñ€ÐµÐ¹Ñ‚:",
    profitLabel: "ÐŸÑ€Ð¸Ð±Ñ‹Ð»ÑŒ",
    streakLabel: "Ð¡ÐµÑ€Ð¸Ñ",
    generateSignalBtn: "Ð¡ÐšÐÐÐ˜Ð ÐžÐ’ÐÐ¢Ð¬ Ð Ð«ÐÐžÐš (1 ÐœÐ˜Ð)",
    tradersTitle: "Ð–Ð˜Ð’Ð«Ð• Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð«",
    pairsTitle: "Ð“ÐžÐ Ð¯Ð§Ð˜Ð• ÐÐšÐ¢Ð˜Ð’Ð«",
    readyMsg: "Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ Ð“ÐžÐ¢ÐžÐ’Ð. ÐžÐ–Ð˜Ð”ÐÐÐ˜Ð• ÐÐÐÐ›Ð˜Ð—Ð...",
    scanStatus: "Ð¡ÐšÐÐÐ˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð Ð«ÐÐšÐ...",
    resReliability: "Ð£Ð’Ð•Ð Ð•ÐÐÐžÐ¡Ð¢Ð¬",
    trend: "Ð¢Ð Ð•ÐÐ”",
    aiWelcome: "ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Spark AI. Ð“Ð¾Ñ‚Ð¾Ð² Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€Ñ‹Ð½ÐºÐ¸?"
  },
  hi: {
    mainTitle: "SPARK TRADING PRO",
    subtitle: "à¤•à¥à¤µà¤¾à¤‚à¤Ÿà¤® à¤à¤²à¥à¤—à¥‹à¤°à¤¿à¤¥à¤® à¤¸à¤¿à¤¸à¥à¤Ÿà¤®",
    energyTitle: "à¤Šà¤°à¥à¤œà¤¾ à¤•à¥‹à¤°",
    addEnergyBtn: "à¤•à¥‹à¤¡ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚",
    claimEnergyBtn: "à¤®à¥à¤«à¥à¤¤ à¤Šà¤°à¥à¤œà¤¾",
    statsTitle: "à¤ªà¥à¤°à¤¦à¤°à¥à¤¶à¤¨",
    signalsLabel: "à¤¸à¤¿à¤—à¥à¤¨à¤²:",
    successLabel: "à¤œà¥€à¤¤ à¤¦à¤°:",
    profitLabel: "à¤²à¤¾à¤­",
    streakLabel: "à¤²à¤—à¤¾à¤¤à¤¾à¤° à¤œà¥€à¤¤",
    generateSignalBtn: "à¤®à¤¾à¤°à¥à¤•à¥‡à¤Ÿ à¤¸à¥à¤•à¥ˆà¤¨ à¤•à¤°à¥‡à¤‚ (1 à¤®à¤¿à¤¨à¤Ÿ)",
    tradersTitle: "à¤²à¤¾à¤‡à¤µ à¤ªà¤°à¤¿à¤£à¤¾à¤®",
    pairsTitle: "à¤¹à¥‰à¤Ÿ à¤à¤¸à¥‡à¤Ÿà¥à¤¸",
    readyMsg: "à¤¸à¤¿à¤¸à¥à¤Ÿà¤® à¤¤à¥ˆà¤¯à¤¾à¤°à¥¤ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤•à¥€ à¤ªà¥à¤°à¤¤à¥€à¤•à¥à¤·à¤¾...",
    scanStatus: "à¤®à¤¾à¤°à¥à¤•à¥‡à¤Ÿ à¤¡à¥‡à¤Ÿà¤¾ à¤¸à¥à¤•à¥ˆà¤¨ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    resReliability: "à¤µà¤¿à¤¶à¥à¤µà¤¾à¤¸",
    trend: "à¤Ÿà¥à¤°à¥‡à¤‚à¤¡",
    aiWelcome: "à¤¨à¤®à¤¸à¥à¤¤à¥‡! à¤®à¥ˆà¤‚ Spark AI à¤¹à¥‚à¤à¥¤ à¤•à¥à¤¯à¤¾ à¤†à¤ª à¤®à¤¾à¤°à¥à¤•à¥‡à¤Ÿ à¤•à¤¾ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤¤à¥ˆà¤¯à¤¾à¤° à¤¹à¥ˆà¤‚?"
  }
};

const languages = [
  { code: 'en', name: 'English', flag: 'ðŸ‡¬ðŸ‡§' },
  { code: 'id', name: 'Indonesia', flag: 'ðŸ‡®ðŸ‡©' },
  { code: 'es', name: 'EspaÃ±ol', flag: 'ðŸ‡ªðŸ‡¸' },
  { code: 'pt', name: 'PortuguÃªs', flag: 'ðŸ‡§ðŸ‡·' },
  { code: 'ru', name: 'Ð ÑƒÑÑÐºÐ¸Ð¹', flag: 'ðŸ‡·ðŸ‡º' },
  { code: 'hi', name: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€', flag: 'ðŸ‡®ðŸ‡³' },
  { code: 'fr', name: 'FranÃ§ais', flag: 'ðŸ‡«ðŸ‡·' },
  { code: 'de', name: 'Deutsch', flag: 'ðŸ‡©ðŸ‡ª' },
  { code: 'ja', name: 'æ—¥æœ¬èªž', flag: 'ðŸ‡¯ðŸ‡µ' },
  { code: 'zh', name: 'ä¸­æ–‡', flag: 'ðŸ‡¨ðŸ‡³' },
  { code: 'ar', name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ðŸ‡¸ðŸ‡¦' }
];

let currentLang = localStorage.getItem('spark_lang') || 'en';

/* --- STATE MANAGEMENT --- */
let state = {
  // UPGRADE: Force start with 0 energy by using a new key 'spark_energy_v2' to ignore old saves
  energy: parseInt(localStorage.getItem('spark_energy_v2')) || 0,
  maxEnergy: 35,
  isUnlimited: localStorage.getItem('spark_unlimited') === 'true',
  signals: parseInt(localStorage.getItem('spark_signals')) || 0,
  wins: parseInt(localStorage.getItem('spark_wins')) || 0,
  profit: parseInt(localStorage.getItem('spark_profit')) || 0,
  streak: parseInt(localStorage.getItem('spark_streak')) || 0,
  maxStreak: parseInt(localStorage.getItem('spark_maxStreak')) || 0
};

const validCodes = ["SPARK2024", "PROTRADER", "MOONSHOT", "QUOTEXKING", "WINNER", "CYBERPUNK", "X9H2L", "G4T7Y", "M8K1Q"];
const unlimitedCodes = ["ADMIN_GOD", "DEV_MODE", "UNLIMITED_POWER", "TRXQ91", "830377", "RA5UL"];

// UPGRADE: ADDED MORE ASSETS FOR IPHONE USER
const assets = {
  real: [
    "EUR/USD", "GBP/USD", "USD/JPY", "USD/CHF", "USD/CAD", "AUD/USD", "NZD/USD",
    "EUR/GBP", "EUR/JPY", "GBP/JPY", "USD/BDT", "USD/INR",
    "BTC/USD", "ETH/USD", "XRP/USD", "LTC/USD",
    "XAU/USD (GOLD)", "XAG/USD (SILVER)", "US30", "SPX500"
  ],
  otc: [
    "EUR/USD OTC", "GBP/USD OTC", "USD/JPY OTC", "USD/CHF OTC", "USD/CAD OTC",
    "AUD/CAD OTC", "NZD/USD OTC", "USD/BRL OTC", "USD/INR OTC", "USD/BDT OTC",
    "USD/PKR OTC", "USD/IDR OTC", "USD/MXN OTC", "USD/TRY OTC",
    "BTC/USD OTC", "ETH/USD OTC", "GBP/JPY OTC", "EUR/NZD OTC"
  ]
};

/* --- INITIALIZATION --- */
window.onload = () => {
  initLangMenu();
  applyLanguage(currentLang);
  initBackground();
  updateStatsUI();
  updateAssets();
  initChart();
  renderHotPairs();
  startTraderFeed();
  startClock();
};

function playClick() {
  document.getElementById('sfxClick').volume = 0.2;
  document.getElementById('sfxClick').currentTime = 0;
  document.getElementById('sfxClick').play().catch(e=>{});
}

function saveData() {
  // Save to new key to persist the 0 start for future visits (unless they add energy)
  localStorage.setItem('spark_energy_v2', state.energy);
  localStorage.setItem('spark_unlimited', state.isUnlimited);
  localStorage.setItem('spark_signals', state.signals);
  localStorage.setItem('spark_wins', state.wins);
  localStorage.setItem('spark_profit', state.profit);
  localStorage.setItem('spark_streak', state.streak);
}

/* --- LANGUAGE SYSTEM --- */
function initLangMenu() {
  const menu = document.getElementById('langMenu');
  languages.forEach(l => {
    const div = document.createElement('div');
    div.className = 'lang-opt';
    div.innerHTML = `<span style="font-size:1.2rem">${l.flag}</span> <span>${l.name}</span>`;
    div.onclick = () => {
      currentLang = l.code;
      localStorage.setItem('spark_lang', currentLang);
      applyLanguage(l.code);
      toggleLangMenu();
      playClick();
    };
    menu.appendChild(div);
  });
}

function toggleLangMenu() {
  const menu = document.getElementById('langMenu');
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function applyLanguage(code) {
  const t = translations[code] || translations['en']; // Fallback
  
  const map = {
    mainTitle: 'mainTitle',
    subtitle: 'subtitle',
    energyTitle: 'energyTitle',
    addEnergyBtn: 'addEnergyBtn',
    // claimEnergyBtn: 'claimEnergyBtn', // REMOVED BUTTON
    statsTitle: 'statsTitle',
    signalsLabel: 'signalsLabel',
    successLabel: 'successLabel',
    profitLabel: 'profitLabel',
    streakLabel: 'streakLabel',
    generateSignalBtn: 'generateSignalBtn',
    tradersTitle: 'tradersTitle',
    pairsTitle: 'pairsTitle',
    readyMsg: 'readyMsg',
    scanStatus: 'scanStatus'
  };

  for (const [id, key] of Object.entries(map)) {
    const el = document.getElementById(id);
    if(el) {
      if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = t[key];
      else el.textContent = t[key];
    }
  }

  // Update AI welcome if chat is empty
  const chatBody = document.getElementById('chatBody');
  if(chatBody.children.length <= 1) {
    chatBody.innerHTML = `<div class="msg msg-bot">${t.aiWelcome}</div>`;
  }
}

/* --- ENERGY & STATS UI --- */
function updateStatsUI() {
  const energyVal = document.getElementById('energyValue');
  const energyBar = document.getElementById('energyBar');
  
  if (state.isUnlimited) {
    energyVal.textContent = "âˆž";
    energyBar.style.width = "100%";
    energyBar.style.boxShadow = "0 0 20px var(--primary)";
  } else {
    energyVal.textContent = state.energy + " / " + state.maxEnergy;
    const pct = (state.energy / state.maxEnergy) * 100;
    energyBar.style.width = pct + "%";
  }

  document.getElementById('signalsGenerated').textContent = state.signals;
  document.getElementById('profitTotal').textContent = "$" + state.profit.toLocaleString();
  document.getElementById('winStreak').textContent = state.streak;
  
  const rate = state.signals > 0 ? Math.round((state.wins / state.signals) * 100) : 0;
  document.getElementById('successRate').textContent = rate + "%";
}

function promptEnergy() {
  playClick();
  const code = prompt("ENTER ACCESS CODE:");
  if (!code) return;
  
  if (unlimitedCodes.includes(code.toUpperCase())) {
    state.isUnlimited = true;
    alert("ACCESS GRANTED: UNLIMITED POWER UNLOCKED");
  } else if (validCodes.includes(code.toUpperCase())) {
    state.energy = Math.min(state.energy + 10, state.maxEnergy);
    alert("ACCESS GRANTED: +10 ENERGY UNITS");
  } else {
    alert("ACCESS DENIED: INVALID KEY");
  }
  saveData();
  updateStatsUI();
}

/* --- ASSET MANAGEMENT --- */
function updateAssets() {
  const type = document.getElementById('marketType').value;
  const select = document.getElementById('assetSelect');
  select.innerHTML = "";
  assets[type].forEach(a => {
    const opt = document.createElement('option');
    opt.value = a;
    opt.textContent = a;
    select.appendChild(opt);
  });
  resetChart();
}

function renderHotPairs() {
  const container = document.getElementById('hotPairsList');
  const hot = [
    { name: "EUR/USD OTC", payout: "92%" },
    { name: "XAU/USD", payout: "89%" },
    { name: "GBP/JPY", payout: "87%" }
  ];
  
  container.innerHTML = "";
  hot.forEach(p => {
    const div = document.createElement('div');
    div.style.cssText = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,0.05);";
    div.innerHTML = `<span>${p.name}</span> <span style="color:var(--success)">${p.payout}</span>`;
    container.appendChild(div);
  });
}

/* --- CANVAS CHART ENGINE (CUSTOM) --- */
let chartCtx, chartCanvas;
let candles = [];
let chartInterval;

function initChart() {
  chartCanvas = document.getElementById('mainChart');
  chartCtx = chartCanvas.getContext('2d');
  
  // Handle high DPI
  const dpr = window.devicePixelRatio || 1;
  const rect = chartCanvas.getBoundingClientRect();
  chartCanvas.width = rect.width * dpr;
  chartCanvas.height = rect.height * dpr;
  chartCtx.scale(dpr, dpr);
  
  resetChart();
  chartInterval = setInterval(updateChart, 100);
}

function resetChart() {
  // Generate initial history
  candles = [];
  let price = 1000 + Math.random() * 500;
  for(let i=0; i<40; i++) {
    const open = price;
    const close = price + (Math.random() - 0.5) * 10;
    const high = Math.max(open, close) + Math.random() * 5;
    const low = Math.min(open, close) - Math.random() * 5;
    candles.push({ open, close, high, low });
    price = close;
  }
}

function updateChart() {
  const w = chartCanvas.width / (window.devicePixelRatio || 1);
  const h = chartCanvas.height / (window.devicePixelRatio || 1);
  
  // Clear
  chartCtx.clearRect(0, 0, w, h);
  
  // Background Grid
  chartCtx.strokeStyle = "rgba(255,255,255,0.05)";
  chartCtx.lineWidth = 1;
  for(let i=0; i<w; i+=50) { chartCtx.beginPath(); chartCtx.moveTo(i,0); chartCtx.lineTo(i,h); chartCtx.stroke(); }
  for(let i=0; i<h; i+=50) { chartCtx.beginPath(); chartCtx.moveTo(0,i); chartCtx.lineTo(w,i); chartCtx.stroke(); }

  // Update Last Candle (Live feel)
  let last = candles[candles.length - 1];
  if(Math.random() > 0.8) {
    last.close += (Math.random() - 0.5) * 2;
    if(last.close > last.high) last.high = last.close;
    if(last.close < last.low) last.low = last.close;
  }
  
  // Add new candle occasionally
  if(Math.random() > 0.98) {
    const open = last.close;
    candles.push({ open, close: open, high: open, low: open });
    if(candles.length > 50) candles.shift();
  }

  // Draw Candles
  const candleW = w / 40; // visible candles
  const maxPrice = Math.max(...candles.map(c => c.high));
  const minPrice = Math.min(...candles.map(c => c.low));
  const range = maxPrice - minPrice;
  const padding = 20;

  candles.forEach((c, i) => {
    const x = i * candleW;
    const yOpen = h - padding - ((c.open - minPrice) / range) * (h - padding*2);
    const yClose = h - padding - ((c.close - minPrice) / range) * (h - padding*2);
    const yHigh = h - padding - ((c.high - minPrice) / range) * (h - padding*2);
    const yLow = h - padding - ((c.low - minPrice) / range) * (h - padding*2);

    const isGreen = c.close >= c.open;
    chartCtx.fillStyle = isGreen ? "#00ff9d" : "#ff3860";
    chartCtx.strokeStyle = isGreen ? "#00ff9d" : "#ff3860";

    // Wick
    chartCtx.beginPath();
    chartCtx.moveTo(x + candleW/2, yHigh);
    chartCtx.lineTo(x + candleW/2, yLow);
    chartCtx.stroke();

    // Body
    const bodyH = Math.max(Math.abs(yClose - yOpen), 1);
    chartCtx.fillRect(x + 2, Math.min(yOpen, yClose), candleW - 4, bodyH);
  });

  // Update HUD
  document.getElementById('candleClose').textContent = last.close.toFixed(2);
  document.getElementById('candleHigh').textContent = last.high.toFixed(2);
}

/* --- ANALYSIS LOGIC --- */
async function startAnalysis() {
  playClick();
  
  if (!state.isUnlimited && state.energy <= 0) {
    alert("ENERGY DEPLETED. PLEASE RECHARGE.");
    return;
  }

  if (!state.isUnlimited) state.energy--;
  state.signals++;
  saveData();
  updateStatsUI();

  // UI Transition
  const box = document.getElementById('signalBox');
  document.getElementById('signalPlaceholder').style.display = 'none';
  document.getElementById('resultUI').style.display = 'none';
  document.getElementById('scanningUI').style.display = 'block';
  box.classList.add('active');

  // Random Logic for Signal Direction
  const isBuy = Math.random() > 0.5;
  const direction = isBuy ? "CALL (BUY)" : "PUT (SELL)";
  const asset = document.getElementById('assetSelect').value;

  // Simulate scanning steps
  let step = 0;
  const steps = [
    { rsi: "22...", macd: "CALC.." },
    { rsi: "45...", macd: "-0.02" },
    { rsi: "68...", macd: "+0.15" },
    { rsi: "DONE", macd: "OK" }
  ];
  
  // Start fetching Gemini reasoning immediately
  const reasoningPromise = callGemini(
    `Generate a very short (max 15 words) technical trading justification for a ${direction} signal on ${asset}. Use technical terms like 'RSI divergence', 'MACD crossover', 'support rejection', 'volume spike', etc. Sound professional.`
  );

  const timer = setInterval(async () => {
    if(step < steps.length) {
      document.getElementById('scanRsi').textContent = steps[step].rsi;
      document.getElementById('scanMacd').textContent = steps[step].macd;
      step++;
    } else {
      clearInterval(timer);
      const reasoning = await reasoningPromise; // Wait for Gemini if not ready
      showResult(isBuy, direction, reasoning);
    }
  }, 800);
}

function showResult(isBuy, direction, reasoning) {
  document.getElementById('scanningUI').style.display = 'none';
  const resUI = document.getElementById('resultUI');
  resUI.style.display = 'grid';
  
  const color = isBuy ? "var(--success)" : "var(--danger)";
  const trend = isBuy ? "BULLISH" : "BEARISH";
  
  const txt = document.getElementById('signalText');
  txt.innerHTML = `${direction} ${isBuy ? 'ðŸ”¼' : 'ðŸ”½'}`;
  txt.style.color = color;
  
  document.getElementById('resRsi').textContent = Math.floor(Math.random() * 40 + 30);
  document.getElementById('resTrend').textContent = trend;
  document.getElementById('resReliability').textContent = Math.floor(Math.random() * 10 + 88) + "%";

  // Show AI Reasoning
  const reasonBox = document.getElementById('aiReasoning');
  reasonBox.innerHTML = `âœ¨ <b>Spark AI Analysis:</b> "${reasoning}"`;

  // Auto Win (Simulation)
  setTimeout(() => {
    state.wins++;
    state.streak++;
    state.profit += Math.floor(Math.random() * 50) + 10;
    saveData();
    updateStatsUI();
    document.getElementById('sfxWin').play().catch(e=>{});
    
    // Confetti effect could go here
  }, 5000);
}

/* --- BACKGROUND ANIMATION --- */
function initBackground() {
  const c = document.getElementById('canvas-bg');
  const x = c.getContext('2d');
  let w, h;
  
  const resize = () => {
    w = c.width = window.innerWidth;
    h = c.height = window.innerHeight;
  };
  window.addEventListener('resize', resize);
  resize();

  const particles = [];
  for(let i=0; i<50; i++) {
    particles.push({
      x: Math.random() * w,
      y: Math.random() * h,
      vx: (Math.random() - 0.5) * 0.5,
      vy: (Math.random() - 0.5) * 0.5,
      size: Math.random() * 2
    });
  }

  function anim() {
    x.clearRect(0,0,w,h);
    // Radial gradient background handled in CSS, just draw particles
    x.fillStyle = "rgba(0, 255, 204, 0.3)";
    
    particles.forEach(p => {
      p.x += p.vx;
      p.y += p.vy;
      if(p.x < 0) p.x = w;
      if(p.x > w) p.x = 0;
      if(p.y < 0) p.y = h;
      if(p.y > h) p.y = 0;
      
      x.beginPath();
      x.arc(p.x, p.y, p.size, 0, Math.PI*2);
      x.fill();
    });
    
    // Connect lines
    x.strokeStyle = "rgba(0, 255, 204, 0.05)";
    for(let i=0; i<particles.length; i++) {
      for(let j=i+1; j<particles.length; j++) {
        const dx = particles[i].x - particles[j].x;
        const dy = particles[i].y - particles[j].y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < 100) {
          x.beginPath();
          x.moveTo(particles[i].x, particles[i].y);
          x.lineTo(particles[j].x, particles[j].y);
          x.stroke();
        }
      }
    }
    requestAnimationFrame(anim);
  }
  anim();
}

/* --- SOCIAL FEED SIMULATOR --- */
function startTraderFeed() {
  const names = ["AlexTrader", "CryptoKing", "ProfitHunter", "SarahW", "QuotexPro", "BinanceWhale"];
  const feed = document.getElementById('traderFeed');
  
  setInterval(() => {
    const name = names[Math.floor(Math.random() * names.length)];
    const profit = Math.floor(Math.random() * 1000) + 50;
    
    const div = document.createElement('div');
    div.className = 'trader-item';
    div.innerHTML = `
      <span><i class="fas fa-user-astronaut"></i> ${name}</span>
      <span style="color:var(--success)">+$${profit}</span>
    `;
    feed.insertBefore(div, feed.firstChild);
    if(feed.children.length > 20) feed.removeChild(feed.lastChild);
  }, 2500);
}

/* --- CLOCK --- */
function startClock() {
  setInterval(() => {
    const d = new Date();
    document.getElementById('clock').textContent = d.toISOString().split('T')[0] + " " + d.toLocaleTimeString();
  }, 1000);
}

/* --- AI CHAT SYSTEM (GEMINI POWERED) --- */
function toggleChat() {
  const w = document.getElementById('chatWindow');
  w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
}

async function handleChat(e) {
  if(e.key === 'Enter') {
    const input = document.getElementById('chatInput');
    const txt = input.value.trim();
    if(!txt) return;
    
    addMsg(txt, 'user');
    input.value = "";
    
    // Loading State
    const loadingId = addMsg('Thinking...', 'bot', true);
    
    // Call Gemini
    const prompt = `You are Spark AI, a futuristic and professional trading assistant in a simulated trading app. User asks: "${txt}". Answer concisely (max 50 words) in a helpful, slightly cyberpunk persona.`;
    const reply = await callGemini(prompt);
    
    // Remove loading and add real message
    const loadingEl = document.getElementById(loadingId);
    if(loadingEl) loadingEl.remove();
    
    addMsg(reply, 'bot');
  }
}

function addMsg(txt, type, isLoading = false) {
  const body = document.getElementById('chatBody');
  const div = document.createElement('div');
  const id = 'msg-' + Date.now();
  div.id = id;
  div.className = `msg msg-${type} ${isLoading ? 'msg-loading' : ''}`;
  div.textContent = txt;
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
  return id;
}

</script>
</body>
</html>
